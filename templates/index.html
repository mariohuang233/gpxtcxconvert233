<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🥷秘术-GPX转TCX转换器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container fade-in">
        <div class="header">
            <h1>🏃‍♂️ 佳明杀手-GPX转TCX转换器</h1>
            <p>我是没有感情的佳明杀手，专门将您的GPX轨迹文件转换为专业的佳明TCX格式，支持心率、步频、功率等数据模拟</p>
        </div>

        <div class="author-info card" style="animation: fadeIn 0.8s ease 0.2s both;">
            <h3>👨‍💻 开发者信息</h3>
            <p><strong>作者:</strong> mariohuang</p>
            <p><strong>⚠️ 重要提醒:</strong> 我是没有感情的佳明杀手，仅用于测试场景，不能作为比赛作弊用途，违反者必究</p>
        </div>

        <div class="status-indicator status-error" id="errorMessage" style="display: none;"></div>

        <div class="upload-section card" style="animation: fadeIn 0.8s ease 0.4s both;">
            <div class="file-upload" id="fileUpload">
                <div class="upload-icon">📁</div>
                <div class="upload-text">点击选择GPX文件或拖拽到此处</div>
                <div class="upload-hint">支持最大16MB的GPX文件</div>
                <input type="file" id="fileInput" accept=".gpx" style="display: none;" />
            </div>
        </div>

        <div class="config-section card" style="animation: fadeIn 0.8s ease 0.6s both;">
            <div class="config-title">转换配置</div>
            <form id="configForm">
                <div class="config-grid">
                    <div class="config-group">
                        <h3>🏃‍♂️ 运动设置</h3>
                        <div class="form-group">
                            <label for="activityType">运动类型</label>
                            <select id="activityType" name="activity_type">
                                <option value="Running">跑步</option>
                                <option value="Cycling">骑行</option>
                                <option value="Walking">步行</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="targetPace">目标配速 (分:秒/公里)</label>
                            <input type="text" id="targetPace" name="target_pace" value="5:30" placeholder="5:30">
                        </div>
                        <div class="form-group">
                            <label for="weight">体重 (kg)</label>
                            <input type="number" id="weight" name="weight" value="70" min="30" max="200">
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>💓 心率设置</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="baseHr">基础心率</label>
                                <input type="number" id="baseHr" name="base_hr" value="135" min="60" max="200">
                            </div>
                            <div class="form-group">
                                <label for="maxHr">最大心率</label>
                                <input type="number" id="maxHr" name="max_hr" value="165" min="100" max="220">
                            </div>
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>🦵 步频设置</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="baseCadenceDisplay">基础步频 (显示)</label>
                                <input type="number" id="baseCadenceDisplay" value="100" min="60" max="200" onchange="updateCadenceValue('base')">
                                <input type="hidden" id="baseCadence" name="base_cadence" value="50">
                            </div>
                            <div class="form-group">
                                <label for="maxCadenceDisplay">最大步频 (显示)</label>
                                <input type="number" id="maxCadenceDisplay" value="140" min="100" max="240" onchange="updateCadenceValue('max')">
                                <input type="hidden" id="maxCadence" name="max_cadence" value="70">
                            </div>
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>⚡ 功率设置</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="basePower">基础功率</label>
                                <input type="number" id="basePower" name="base_power" value="150" min="50" max="500">
                            </div>
                            <div class="form-group">
                                <label for="maxPower">最大功率</label>
                                <input type="number" id="maxPower" name="max_power" value="300" min="100" max="800">
                            </div>
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>📱 设备信息</h3>
                        <div class="form-group">
                            <label>设备名称</label>
                            <input type="text" value="Forerunner 570" disabled style="background: #f5f5f5; color: #666;">
                            <input type="hidden" name="device_name" value="Forerunner 570">
                        </div>
                        <div class="form-group">
                            <label>设备版本</label>
                            <input type="text" value="12.70" disabled style="background: #f5f5f5; color: #666;">
                            <input type="hidden" name="device_version" value="12.70">
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>🕐 时间设置</h3>
                        <div class="form-group">
                            <label for="startTime">自定义开始时间 (可选)</label>
                            <input type="datetime-local" id="startTime" name="start_time">
                        </div>
                        <div class="form-group">
                            <label for="caloriesPerKm">卡路里/公里</label>
                            <input type="number" id="caloriesPerKm" name="calories_per_km" value="60" min="30" max="150">
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="convert-section">
            <button id="convertBtn" class="btn btn-primary btn-large" disabled>
                <span class="btn-icon">🔄</span>
                <span class="btn-text">开始转换</span>
                <div class="btn-ripple"></div>
            </button>
        </div>

        <div class="progress-section card" id="progressSection" style="display: none;">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">准备转换...</div>
            </div>
        </div>

        <div class="result-section card" id="resultSection" style="display: none;">
            <div class="result-content">
                <div class="result-icon" id="resultIcon">✅</div>
                <div class="result-message" id="resultMessage">转换完成！</div>
                <div class="result-actions">
                    <button id="downloadBtn" class="btn btn-success">
                        <span class="btn-icon">⬇️</span>
                        <span class="btn-text">下载TCX文件</span>
                        <div class="btn-ripple"></div>
                    </button>
                    <button id="resetBtn" class="btn btn-secondary">
                        <span class="btn-icon">🔄</span>
                        <span class="btn-text">重新转换</span>
                        <div class="btn-ripple"></div>
                    </button>
                </div>
            </div>
        </div>

        <div class="greeting-section card" style="animation: fadeIn 0.8s ease 0.7s both;">
            <h3>🌟 个性化问候</h3>
            <div class="greeting-content">
                <div id="greetingDisplay" class="greeting-display">
                    <p id="greetingText" class="greeting-text">正在获取您的位置和天气信息...</p>
                    <div id="weatherDetails" class="weather-details" style="display: none;">
                        <div class="weather-grid">
                            <div class="weather-item">
                                <span class="weather-icon">🌡️</span>
                                <div>
                                    <strong>温度</strong>
                                    <span id="temperature">-</span>°C
                                </div>
                            </div>
                            <div class="weather-item">
                                <span class="weather-icon">💧</span>
                                <div>
                                    <strong>湿度</strong>
                                    <span id="humidity">-</span>%
                                </div>
                            </div>
                            <div class="weather-item">
                                <span class="weather-icon">💨</span>
                                <div>
                                    <strong>风速</strong>
                                    <span id="windSpeed">-</span> km/h
                                </div>
                            </div>
                            <div class="weather-item">
                                <span class="weather-icon">📍</span>
                                <div>
                                    <strong>位置</strong>
                                    <span id="location">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="greetingError" class="status-indicator status-error" style="display: none;"></div>
            </div>
        </div>

        <div class="features card" style="animation: fadeIn 0.8s ease 0.8s both;">
            <h3>✨ 功能特色</h3>
            <div class="feature-grid">
                <div class="feature-item">
                    <div class="feature-icon">🎯</div>
                    <div class="feature-content">
                        <div class="feature-title">精确转换</div>
                        <div class="feature-desc">保持原始轨迹精度，完美兼容各种设备</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">📊</div>
                    <div class="feature-content">
                        <div class="feature-title">数据丰富</div>
                        <div class="feature-desc">自动生成心率、步频、功率等专业数据</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">⚙️</div>
                    <div class="feature-content">
                        <div class="feature-title">高度自定义</div>
                        <div class="feature-desc">支持详细的参数配置，满足个性化需求</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">🔒</div>
                    <div class="feature-content">
                        <div class="feature-title">隐私安全</div>
                        <div class="feature-desc">文件本地处理，1小时后自动清理</div>
                    </div>
                </div>
                <div class="feature-item">
                        <div class="feature-icon">🌟</div>
                        <div class="feature-content">
                            <div class="feature-title">个性化问候</div>
                            <div class="feature-desc">基于位置的智能天气信息和个性化问候语</div>
                        </div>
                    </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let currentTaskId = null;

        // 文件上传处理
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const errorMessage = document.getElementById('errorMessage');
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');

        // 添加按钮涟漪效果
        function addRippleEffect(button, event) {
            const ripple = button.querySelector('.btn-ripple');
            if (!ripple) return;
            
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple-active');
            
            setTimeout(() => {
                ripple.classList.remove('ripple-active');
            }, 600);
        }

        // 为所有按钮添加涟漪效果
        document.addEventListener('click', (event) => {
            if (event.target.closest('.btn')) {
                addRippleEffect(event.target.closest('.btn'), event);
            }
        });

        // 点击上传区域
        fileUpload.addEventListener('click', () => {
            fileInput.click();
        });

        // 文件选择
        fileInput.addEventListener('change', handleFileSelect);

        // 拖拽处理
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });

        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });

        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // 检查文件类型
            if (!file.name.toLowerCase().endsWith('.gpx')) {
                showError('请选择GPX格式的文件');
                return;
            }

            // 检查文件大小 (16MB)
            if (file.size > 16 * 1024 * 1024) {
                showError('文件大小不能超过16MB');
                return;
            }

            selectedFile = file;
            updateUploadUI();
            fileUpload.classList.add('file-selected');
            convertBtn.disabled = false;
            convertBtn.classList.add('btn-ready');
            hideError();
        }

        function updateUploadUI() {
            if (selectedFile) {
                fileUpload.innerHTML = `
                    <div class="upload-icon">✅</div>
                    <div class="upload-text">已选择: ${selectedFile.name}</div>
                    <div class="upload-hint">文件大小: ${(selectedFile.size / 1024 / 1024).toFixed(2)} MB</div>
                `;
            }
        }

        // 转换按钮
        convertBtn.addEventListener('click', startConversion);
        resetBtn.addEventListener('click', resetConversion);

        async function startConversion() {
            if (!selectedFile) {
                showError('请先选择GPX文件');
                return;
            }

            // 准备表单数据
            const formData = new FormData();
            formData.append('file', selectedFile);

            // 添加配置数据
            const configForm = document.getElementById('configForm');
            const formElements = configForm.elements;
            for (let element of formElements) {
                if (element.name && element.value) {
                    formData.append(element.name, element.value);
                }
            }

            try {
                convertBtn.disabled = true;
                convertBtn.classList.add('btn-loading');
                convertBtn.querySelector('.btn-text').textContent = '转换中...';
                convertBtn.querySelector('.btn-icon').textContent = '⏳';
                hideError();
                resultSection.style.display = 'none';

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    currentTaskId = result.task_id;
                    showProgress();
                    pollStatus();
                } else {
                    throw new Error(result.error || '上传失败');
                }
            } catch (error) {
                showError(error.message);
                resetUI();
            }
        }

        function resetConversion() {
            selectedFile = null;
            currentTaskId = null;
            
            // 重置文件上传区域
            fileUpload.innerHTML = `
                <div class="upload-icon">📁</div>
                <div class="upload-text">点击选择GPX文件或拖拽到此处</div>
                <div class="upload-hint">支持最大16MB的GPX文件</div>
            `;
            fileUpload.classList.remove('file-selected');
            
            // 重置按钮状态
            convertBtn.disabled = true;
            convertBtn.classList.remove('btn-ready', 'btn-loading');
            convertBtn.querySelector('.btn-text').textContent = '开始转换';
            convertBtn.querySelector('.btn-icon').textContent = '🔄';
            
            // 隐藏进度和结果
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            hideError();
        }

        function showProgress() {
            progressSection.style.display = 'block';
            progressSection.classList.add('fade-in');
            progressFill.style.width = '0%';
            progressText.textContent = '准备中...';
        }

        async function pollStatus() {
            if (!currentTaskId) return;

            try {
                const response = await fetch(`/status/${currentTaskId}`);
                const status = await response.json();

                if (response.ok) {
                    updateProgress(status.progress, status.message);

                    if (status.status === 'completed') {
                        showSuccess();
                    } else if (status.status === 'error') {
                        throw new Error(status.error || '转换失败');
                    } else {
                        // 继续轮询
                        setTimeout(pollStatus, 1000);
                    }
                } else {
                    throw new Error(status.error || '获取状态失败');
                }
            } catch (error) {
                showError(error.message);
                resetUI();
            }
        }

        function updateProgress(progress, message) {
            progressFill.style.width = progress + '%';
            progressText.textContent = message;
            
            // 添加进度动画
            if (progress > 0) {
                progressFill.classList.add('progress-active');
            }
        }

        function showSuccess() {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            resultSection.classList.add('fade-in');
            
            const resultIcon = document.getElementById('resultIcon');
            const resultMessage = document.getElementById('resultMessage');
            
            resultIcon.textContent = '✅';
            resultIcon.classList.add('success-bounce');
            resultMessage.textContent = '转换完成！';
            
            // 正确设置下载按钮的点击事件
            downloadBtn.onclick = () => {
                window.location.href = `/download/${currentTaskId}`;
            };
            resetUI();
        }

        function resetUI() {
            convertBtn.disabled = false;
            convertBtn.classList.remove('btn-loading');
            convertBtn.querySelector('.btn-text').textContent = '开始转换';
            convertBtn.querySelector('.btn-icon').textContent = '🔄';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            errorMessage.classList.add('shake');
            
            setTimeout(() => {
                errorMessage.classList.remove('shake');
            }, 600);
        }

        function hideError() {
            errorMessage.style.display = 'none';
            errorMessage.classList.remove('shake');
        }

        // 步频显示值转换函数
        function updateCadenceValue(type) {
            if (type === 'base') {
                const displayValue = document.getElementById('baseCadenceDisplay').value;
                const actualValue = Math.round(displayValue / 2);
                document.getElementById('baseCadence').value = actualValue;
            } else if (type === 'max') {
                const displayValue = document.getElementById('maxCadenceDisplay').value;
                const actualValue = Math.round(displayValue / 2);
                document.getElementById('maxCadence').value = actualValue;
            }
        }

        // 初始化步频值
        updateCadenceValue('base');
        updateCadenceValue('max');

        // 设置默认开始时间为当前时间
        const now = new Date();
        // 格式化为本地时间字符串 (YYYY-MM-DDTHH:MM)
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const localTimeString = `${year}-${month}-${day}T${hours}:${minutes}`;
        document.getElementById('startTime').value = localTimeString;

        // 个性化问候功能
        const greetingText = document.getElementById('greetingText');
        const weatherDetails = document.getElementById('weatherDetails');
        const greetingError = document.getElementById('greetingError');

        // 页面加载时自动获取问候信息
        async function loadGreeting() {
            try {
                greetingText.textContent = '正在获取您的位置和天气信息...';
                weatherDetails.style.display = 'none';
                greetingError.style.display = 'none';

                const response = await fetch('/greeting-info');
                 const data = await response.json();
 
                 if (data.success) {
                     // 显示问候语
                     greetingText.textContent = data.data.greeting;
                     
                     // 显示天气信息
                     if (data.data.weather) {
                         document.getElementById('temperature').textContent = data.data.weather.temperature;
                         document.getElementById('humidity').textContent = data.data.weather.humidity;
                         document.getElementById('windSpeed').textContent = data.data.weather.wind_speed;
                         document.getElementById('location').textContent = `${data.data.location.city}, ${data.data.location.country}`;
                         
                         weatherDetails.style.display = 'block';
                         weatherDetails.classList.add('fade-in');
                     }
                } else {
                    throw new Error(data.error || '获取问候信息失败');
                }
            } catch (error) {
                greetingText.textContent = '欢迎使用GPX转TCX转换器！';
                greetingError.textContent = `获取位置信息失败: ${error.message}`;
                greetingError.style.display = 'block';
                greetingError.classList.add('shake');
                
                setTimeout(() => {
                    greetingError.classList.remove('shake');
                }, 600);
            }
        }

        // 页面加载完成后自动执行
        document.addEventListener('DOMContentLoaded', loadGreeting);
    </script>
</body>
</html>
