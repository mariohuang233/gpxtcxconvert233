<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥·ç§˜æœ¯-GPXè½¬TCXè½¬æ¢å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container fade-in">
        <div class="header">
            <h1>ğŸƒâ€â™‚ï¸ ä½³æ˜æ€æ‰‹-GPXè½¬TCXè½¬æ¢å™¨</h1>
            <p>æˆ‘æ˜¯æ²¡æœ‰æ„Ÿæƒ…çš„ä½³æ˜æ€æ‰‹ï¼Œä¸“é—¨å°†æ‚¨çš„GPXè½¨è¿¹æ–‡ä»¶è½¬æ¢ä¸ºä¸“ä¸šçš„ä½³æ˜TCXæ ¼å¼ï¼Œæ”¯æŒå¿ƒç‡ã€æ­¥é¢‘ã€åŠŸç‡ç­‰æ•°æ®æ¨¡æ‹Ÿ</p>
        </div>

        <div class="author-info card" style="animation: fadeIn 0.8s ease 0.2s both;">
            <h3>ğŸ‘¨â€ğŸ’» å¼€å‘è€…ä¿¡æ¯</h3>
            <p><strong>ä½œè€…:</strong> mariohuang</p>
            <p><strong>âš ï¸ é‡è¦æé†’:</strong> æˆ‘æ˜¯æ²¡æœ‰æ„Ÿæƒ…çš„ä½³æ˜æ€æ‰‹ï¼Œä»…ç”¨äºæµ‹è¯•åœºæ™¯ï¼Œä¸èƒ½ä½œä¸ºæ¯”èµ›ä½œå¼Šç”¨é€”ï¼Œè¿åè€…å¿…ç©¶</p>
        </div>

        <div class="status-indicator status-error" id="errorMessage" style="display: none;"></div>

        <div class="upload-section card" style="animation: fadeIn 0.8s ease 0.4s both;">
            <div class="file-upload" id="fileUpload">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©GPXæ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒæœ€å¤§16MBçš„GPXæ–‡ä»¶</div>
                <input type="file" id="fileInput" accept=".gpx" style="display: none;" />
            </div>
        </div>

        <div class="config-section card" style="animation: fadeIn 0.8s ease 0.6s both;">
            <div class="config-title">è½¬æ¢é…ç½®</div>
            <form id="configForm">
                <div class="config-grid">
                    <div class="config-group">
                        <h3>ğŸƒâ€â™‚ï¸ è¿åŠ¨è®¾ç½®</h3>
                        <div class="form-group">
                            <label for="activityType">è¿åŠ¨ç±»å‹</label>
                            <select id="activityType" name="activity_type">
                                <option value="Running">è·‘æ­¥</option>
                                <option value="Cycling">éª‘è¡Œ</option>
                                <option value="Walking">æ­¥è¡Œ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="targetPace">ç›®æ ‡é…é€Ÿ (åˆ†:ç§’/å…¬é‡Œ)</label>
                            <input type="text" id="targetPace" name="target_pace" value="5:30" placeholder="5:30">
                        </div>
                        <div class="form-group">
                            <label for="weight">ä½“é‡ (kg)</label>
                            <input type="number" id="weight" name="weight" value="70" min="30" max="200">
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>ğŸ’“ å¿ƒç‡è®¾ç½®</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="baseHr">åŸºç¡€å¿ƒç‡</label>
                                <input type="number" id="baseHr" name="base_hr" value="135" min="60" max="200">
                            </div>
                            <div class="form-group">
                                <label for="maxHr">æœ€å¤§å¿ƒç‡</label>
                                <input type="number" id="maxHr" name="max_hr" value="165" min="100" max="220">
                            </div>
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>ğŸ¦µ æ­¥é¢‘è®¾ç½®</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="baseCadenceDisplay">åŸºç¡€æ­¥é¢‘ (æ˜¾ç¤º)</label>
                                <input type="number" id="baseCadenceDisplay" value="100" min="60" max="200" onchange="updateCadenceValue('base')">
                                <input type="hidden" id="baseCadence" name="base_cadence" value="50">
                            </div>
                            <div class="form-group">
                                <label for="maxCadenceDisplay">æœ€å¤§æ­¥é¢‘ (æ˜¾ç¤º)</label>
                                <input type="number" id="maxCadenceDisplay" value="140" min="100" max="240" onchange="updateCadenceValue('max')">
                                <input type="hidden" id="maxCadence" name="max_cadence" value="70">
                            </div>
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>âš¡ åŠŸç‡è®¾ç½®</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="basePower">åŸºç¡€åŠŸç‡</label>
                                <input type="number" id="basePower" name="base_power" value="150" min="50" max="500">
                            </div>
                            <div class="form-group">
                                <label for="maxPower">æœ€å¤§åŠŸç‡</label>
                                <input type="number" id="maxPower" name="max_power" value="300" min="100" max="800">
                            </div>
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>ğŸ“± è®¾å¤‡ä¿¡æ¯</h3>
                        <div class="form-group">
                            <label>è®¾å¤‡åç§°</label>
                            <input type="text" value="Forerunner 570" disabled style="background: #f5f5f5; color: #666;">
                            <input type="hidden" name="device_name" value="Forerunner 570">
                        </div>
                        <div class="form-group">
                            <label>è®¾å¤‡ç‰ˆæœ¬</label>
                            <input type="text" value="12.70" disabled style="background: #f5f5f5; color: #666;">
                            <input type="hidden" name="device_version" value="12.70">
                        </div>
                    </div>

                    <div class="config-group">
                        <h3>ğŸ• æ—¶é—´è®¾ç½®</h3>
                        <div class="form-group">
                            <label for="startTime">è‡ªå®šä¹‰å¼€å§‹æ—¶é—´ (å¯é€‰)</label>
                            <input type="datetime-local" id="startTime" name="start_time">
                        </div>
                        <div class="form-group">
                            <label for="caloriesPerKm">å¡è·¯é‡Œ/å…¬é‡Œ</label>
                            <input type="number" id="caloriesPerKm" name="calories_per_km" value="60" min="30" max="150">
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="convert-section">
            <button id="convertBtn" class="btn btn-primary btn-large" disabled>
                <span class="btn-icon">ğŸ”„</span>
                <span class="btn-text">å¼€å§‹è½¬æ¢</span>
                <div class="btn-ripple"></div>
            </button>
        </div>

        <div class="progress-section card" id="progressSection" style="display: none;">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">å‡†å¤‡è½¬æ¢...</div>
            </div>
        </div>

        <div class="result-section card" id="resultSection" style="display: none;">
            <div class="result-content">
                <div class="result-icon" id="resultIcon">âœ…</div>
                <div class="result-message" id="resultMessage">è½¬æ¢å®Œæˆï¼</div>
                <div class="result-actions">
                    <button id="downloadBtn" class="btn btn-success">
                        <span class="btn-icon">â¬‡ï¸</span>
                        <span class="btn-text">ä¸‹è½½TCXæ–‡ä»¶</span>
                        <div class="btn-ripple"></div>
                    </button>
                    <button id="resetBtn" class="btn btn-secondary">
                        <span class="btn-icon">ğŸ”„</span>
                        <span class="btn-text">é‡æ–°è½¬æ¢</span>
                        <div class="btn-ripple"></div>
                    </button>
                </div>
            </div>
        </div>

        <div class="greeting-section card" style="animation: fadeIn 0.8s ease 0.7s both;">
            <h3>ğŸŒŸ ä¸ªæ€§åŒ–é—®å€™</h3>
            <div class="greeting-content">
                <div id="greetingDisplay" class="greeting-display">
                    <p id="greetingText" class="greeting-text">æ­£åœ¨è·å–æ‚¨çš„ä½ç½®å’Œå¤©æ°”ä¿¡æ¯...</p>
                    <div id="weatherDetails" class="weather-details" style="display: none;">
                        <div class="weather-grid">
                            <div class="weather-item">
                                <span class="weather-icon">ğŸŒ¡ï¸</span>
                                <div>
                                    <strong>æ¸©åº¦</strong>
                                    <span id="temperature">-</span>Â°C
                                </div>
                            </div>
                            <div class="weather-item">
                                <span class="weather-icon">ğŸ’§</span>
                                <div>
                                    <strong>æ¹¿åº¦</strong>
                                    <span id="humidity">-</span>%
                                </div>
                            </div>
                            <div class="weather-item">
                                <span class="weather-icon">ğŸ’¨</span>
                                <div>
                                    <strong>é£é€Ÿ</strong>
                                    <span id="windSpeed">-</span> km/h
                                </div>
                            </div>
                            <div class="weather-item">
                                <span class="weather-icon">ğŸ“</span>
                                <div>
                                    <strong>ä½ç½®</strong>
                                    <span id="location">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="greetingError" class="status-indicator status-error" style="display: none;"></div>
            </div>
        </div>

        <div class="features card" style="animation: fadeIn 0.8s ease 0.8s both;">
            <h3>âœ¨ åŠŸèƒ½ç‰¹è‰²</h3>
            <div class="feature-grid">
                <div class="feature-item">
                    <div class="feature-icon">ğŸ¯</div>
                    <div class="feature-content">
                        <div class="feature-title">ç²¾ç¡®è½¬æ¢</div>
                        <div class="feature-desc">ä¿æŒåŸå§‹è½¨è¿¹ç²¾åº¦ï¼Œå®Œç¾å…¼å®¹å„ç§è®¾å¤‡</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ğŸ“Š</div>
                    <div class="feature-content">
                        <div class="feature-title">æ•°æ®ä¸°å¯Œ</div>
                        <div class="feature-desc">è‡ªåŠ¨ç”Ÿæˆå¿ƒç‡ã€æ­¥é¢‘ã€åŠŸç‡ç­‰ä¸“ä¸šæ•°æ®</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">âš™ï¸</div>
                    <div class="feature-content">
                        <div class="feature-title">é«˜åº¦è‡ªå®šä¹‰</div>
                        <div class="feature-desc">æ”¯æŒè¯¦ç»†çš„å‚æ•°é…ç½®ï¼Œæ»¡è¶³ä¸ªæ€§åŒ–éœ€æ±‚</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ğŸ”’</div>
                    <div class="feature-content">
                        <div class="feature-title">éšç§å®‰å…¨</div>
                        <div class="feature-desc">æ–‡ä»¶æœ¬åœ°å¤„ç†ï¼Œ1å°æ—¶åè‡ªåŠ¨æ¸…ç†</div>
                    </div>
                </div>
                <div class="feature-item">
                        <div class="feature-icon">ğŸŒŸ</div>
                        <div class="feature-content">
                            <div class="feature-title">ä¸ªæ€§åŒ–é—®å€™</div>
                            <div class="feature-desc">åŸºäºä½ç½®çš„æ™ºèƒ½å¤©æ°”ä¿¡æ¯å’Œä¸ªæ€§åŒ–é—®å€™è¯­</div>
                        </div>
                    </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let currentTaskId = null;

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const errorMessage = document.getElementById('errorMessage');
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');

        // æ·»åŠ æŒ‰é’®æ¶Ÿæ¼ªæ•ˆæœ
        function addRippleEffect(button, event) {
            const ripple = button.querySelector('.btn-ripple');
            if (!ripple) return;
            
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple-active');
            
            setTimeout(() => {
                ripple.classList.remove('ripple-active');
            }, 600);
        }

        // ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ æ¶Ÿæ¼ªæ•ˆæœ
        document.addEventListener('click', (event) => {
            if (event.target.closest('.btn')) {
                addRippleEffect(event.target.closest('.btn'), event);
            }
        });

        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
        fileUpload.addEventListener('click', () => {
            fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', handleFileSelect);

        // æ‹–æ‹½å¤„ç†
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });

        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });

        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.toLowerCase().endsWith('.gpx')) {
                showError('è¯·é€‰æ‹©GPXæ ¼å¼çš„æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å° (16MB)
            if (file.size > 16 * 1024 * 1024) {
                showError('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡16MB');
                return;
            }

            selectedFile = file;
            updateUploadUI();
            fileUpload.classList.add('file-selected');
            convertBtn.disabled = false;
            convertBtn.classList.add('btn-ready');
            hideError();
        }

        function updateUploadUI() {
            if (selectedFile) {
                fileUpload.innerHTML = `
                    <div class="upload-icon">âœ…</div>
                    <div class="upload-text">å·²é€‰æ‹©: ${selectedFile.name}</div>
                    <div class="upload-hint">æ–‡ä»¶å¤§å°: ${(selectedFile.size / 1024 / 1024).toFixed(2)} MB</div>
                `;
            }
        }

        // è½¬æ¢æŒ‰é’®
        convertBtn.addEventListener('click', startConversion);
        resetBtn.addEventListener('click', resetConversion);

        async function startConversion() {
            if (!selectedFile) {
                showError('è¯·å…ˆé€‰æ‹©GPXæ–‡ä»¶');
                return;
            }

            // å‡†å¤‡è¡¨å•æ•°æ®
            const formData = new FormData();
            formData.append('file', selectedFile);

            // æ·»åŠ é…ç½®æ•°æ®
            const configForm = document.getElementById('configForm');
            const formElements = configForm.elements;
            for (let element of formElements) {
                if (element.name && element.value) {
                    formData.append(element.name, element.value);
                }
            }

            try {
                convertBtn.disabled = true;
                convertBtn.classList.add('btn-loading');
                convertBtn.querySelector('.btn-text').textContent = 'è½¬æ¢ä¸­...';
                convertBtn.querySelector('.btn-icon').textContent = 'â³';
                hideError();
                resultSection.style.display = 'none';

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    currentTaskId = result.task_id;
                    showProgress();
                    pollStatus();
                } else {
                    throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                showError(error.message);
                resetUI();
            }
        }

        function resetConversion() {
            selectedFile = null;
            currentTaskId = null;
            
            // é‡ç½®æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            fileUpload.innerHTML = `
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©GPXæ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒæœ€å¤§16MBçš„GPXæ–‡ä»¶</div>
            `;
            fileUpload.classList.remove('file-selected');
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            convertBtn.disabled = true;
            convertBtn.classList.remove('btn-ready', 'btn-loading');
            convertBtn.querySelector('.btn-text').textContent = 'å¼€å§‹è½¬æ¢';
            convertBtn.querySelector('.btn-icon').textContent = 'ğŸ”„';
            
            // éšè—è¿›åº¦å’Œç»“æœ
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            hideError();
        }

        function showProgress() {
            progressSection.style.display = 'block';
            progressSection.classList.add('fade-in');
            progressFill.style.width = '0%';
            progressText.textContent = 'å‡†å¤‡ä¸­...';
        }

        async function pollStatus() {
            if (!currentTaskId) return;

            try {
                const response = await fetch(`/status/${currentTaskId}`);
                const status = await response.json();

                if (response.ok) {
                    updateProgress(status.progress, status.message);

                    if (status.status === 'completed') {
                        showSuccess();
                    } else if (status.status === 'error') {
                        throw new Error(status.error || 'è½¬æ¢å¤±è´¥');
                    } else {
                        // ç»§ç»­è½®è¯¢
                        setTimeout(pollStatus, 1000);
                    }
                } else {
                    throw new Error(status.error || 'è·å–çŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                showError(error.message);
                resetUI();
            }
        }

        function updateProgress(progress, message) {
            progressFill.style.width = progress + '%';
            progressText.textContent = message;
            
            // æ·»åŠ è¿›åº¦åŠ¨ç”»
            if (progress > 0) {
                progressFill.classList.add('progress-active');
            }
        }

        function showSuccess() {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            resultSection.classList.add('fade-in');
            
            const resultIcon = document.getElementById('resultIcon');
            const resultMessage = document.getElementById('resultMessage');
            
            resultIcon.textContent = 'âœ…';
            resultIcon.classList.add('success-bounce');
            resultMessage.textContent = 'è½¬æ¢å®Œæˆï¼';
            
            // æ­£ç¡®è®¾ç½®ä¸‹è½½æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            downloadBtn.onclick = () => {
                window.location.href = `/download/${currentTaskId}`;
            };
            resetUI();
        }

        function resetUI() {
            convertBtn.disabled = false;
            convertBtn.classList.remove('btn-loading');
            convertBtn.querySelector('.btn-text').textContent = 'å¼€å§‹è½¬æ¢';
            convertBtn.querySelector('.btn-icon').textContent = 'ğŸ”„';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            errorMessage.classList.add('shake');
            
            setTimeout(() => {
                errorMessage.classList.remove('shake');
            }, 600);
        }

        function hideError() {
            errorMessage.style.display = 'none';
            errorMessage.classList.remove('shake');
        }

        // æ­¥é¢‘æ˜¾ç¤ºå€¼è½¬æ¢å‡½æ•°
        function updateCadenceValue(type) {
            if (type === 'base') {
                const displayValue = document.getElementById('baseCadenceDisplay').value;
                const actualValue = Math.round(displayValue / 2);
                document.getElementById('baseCadence').value = actualValue;
            } else if (type === 'max') {
                const displayValue = document.getElementById('maxCadenceDisplay').value;
                const actualValue = Math.round(displayValue / 2);
                document.getElementById('maxCadence').value = actualValue;
            }
        }

        // åˆå§‹åŒ–æ­¥é¢‘å€¼
        updateCadenceValue('base');
        updateCadenceValue('max');

        // è®¾ç½®é»˜è®¤å¼€å§‹æ—¶é—´ä¸ºå½“å‰æ—¶é—´
        const now = new Date();
        // æ ¼å¼åŒ–ä¸ºæœ¬åœ°æ—¶é—´å­—ç¬¦ä¸² (YYYY-MM-DDTHH:MM)
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const localTimeString = `${year}-${month}-${day}T${hours}:${minutes}`;
        document.getElementById('startTime').value = localTimeString;

        // ä¸ªæ€§åŒ–é—®å€™åŠŸèƒ½
        const greetingText = document.getElementById('greetingText');
        const weatherDetails = document.getElementById('weatherDetails');
        const greetingError = document.getElementById('greetingError');

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–é—®å€™ä¿¡æ¯
        async function loadGreeting() {
            try {
                greetingText.textContent = 'æ­£åœ¨è·å–æ‚¨çš„ä½ç½®å’Œå¤©æ°”ä¿¡æ¯...';
                weatherDetails.style.display = 'none';
                greetingError.style.display = 'none';

                const response = await fetch('/greeting-info');
                 const data = await response.json();
 
                 if (data.success) {
                     // æ˜¾ç¤ºé—®å€™è¯­
                     greetingText.textContent = data.data.greeting;
                     
                     // æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯
                     if (data.data.weather) {
                         document.getElementById('temperature').textContent = data.data.weather.temperature;
                         document.getElementById('humidity').textContent = data.data.weather.humidity;
                         document.getElementById('windSpeed').textContent = data.data.weather.wind_speed;
                         document.getElementById('location').textContent = `${data.data.location.city}, ${data.data.location.country}`;
                         
                         weatherDetails.style.display = 'block';
                         weatherDetails.classList.add('fade-in');
                     }
                } else {
                    throw new Error(data.error || 'è·å–é—®å€™ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                greetingText.textContent = 'æ¬¢è¿ä½¿ç”¨GPXè½¬TCXè½¬æ¢å™¨ï¼';
                greetingError.textContent = `è·å–ä½ç½®ä¿¡æ¯å¤±è´¥: ${error.message}`;
                greetingError.style.display = 'block';
                greetingError.classList.add('shake');
                
                setTimeout(() => {
                    greetingError.classList.remove('shake');
                }, 600);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', loadGreeting);
    </script>
</body>
</html>
