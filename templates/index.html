<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🥷秘术 - GPX 转 TCX 转换器 - 专业运动数据转换工具</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Leaflet地图库 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🏃</text></svg>">
</head>
<body>
    <div class="container">
        <!-- 全屏居中欢迎区域 -->
        <div class="welcome-section animate-fade-in">
            <h1 class="welcome-title animate-scale-in">GPX 转 TCX 转换器</h1>
            <p class="welcome-subtitle animate-fade-in animate-delay-2">专业的运动数据格式转换工具</p>
            
            <div class="welcome-info animate-slide-up animate-delay-3">
                <div class="info-item">
                    <span class="info-label">格式</span>
                    <span class="info-value">GPX → TCX</span>
                </div>
                <div class="info-item">
                    <span class="info-label">开发者</span>
                    <span class="info-value">mariohuang</span>
                </div>
                <div class="info-item" id="weatherInline" style="display: none;">
                    <span class="info-label">天气:</span>
                    <span class="info-value" id="weatherSummary">--</span>
                </div>
            </div>
            
            <div class="status-indicator status-warning animate-scale-in animate-delay-3" style="margin-top: 1.5rem;">
                ⚠️ 仅供测试使用
            </div>
            
            <div id="greetingError" class="status-indicator status-error" style="display: none;"></div>
            
            <!-- 过渡连接层 -->
            <div class="transition-bridge"></div>
        </div>

        <div class="status-indicator status-error" id="errorMessage" style="display: none;"></div>

        <div class="upload-section animate-slide-up animate-delay-4">
            <div class="card">
                <div class="file-upload" id="fileUpload">
                    <div class="upload-icon">⚡</div>
                    <div class="upload-text">Drop your GPX file</div>
                    <div class="upload-hint">Seamless conversion • Instant results • Professional grade</div>
                    <input type="file" id="fileInput" accept=".gpx" style="display: none;" />
                </div>
                
                <!-- GPX路径可视化区域 -->
                <div class="gpx-preview" id="gpxPreview" style="display: none;">
                    <div class="preview-header">
                        <h4>🗺️ 路径预览</h4>
                        <div class="route-stats" id="routeStats"></div>
                    </div>
                    <div class="map-container">
                        <div id="gpxMap" class="gpx-map"></div>
                    </div>
                    <div class="route-info" id="routeInfo"></div>
                </div>
            </div>
        </div>

        <div class="config-section animate-fade-in animate-delay-2">
            <form id="configForm">
                <div class="config-grid">
                    <!-- 核心配置组 - 最重要的设置 -->
                    <div class="card config-group config-primary animate-scale-in animate-delay-3">
                        <h3>🏃‍♂️ 基础设置</h3>
                        <div class="form-group">
                            <label for="activityType">运动类型</label>
                            <select id="activityType" name="activity_type">
                                <option value="Running">跑步</option>
                                <option value="Cycling">骑行</option>
                                <option value="Walking">步行</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="targetPace">目标配速</label>
                            <input type="text" id="targetPace" name="target_pace" value="5:30" placeholder="5:30">
                        </div>
                        <div class="form-group">
                            <label for="weight">体重 (kg)</label>
                            <input type="number" id="weight" name="weight" value="70" min="30" max="200">
                        </div>
                        <div class="form-group">
                            <label for="caloriesPerKm">每公里卡路里</label>
                            <input type="number" id="caloriesPerKm" name="calories_per_km" value="60" min="30" max="150">
                        </div>
                    </div>

                    <div class="card config-group config-primary animate-scale-in animate-delay-4">
                        <h3>💓 心率与时间</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="baseHr">基础心率</label>
                                <input type="number" id="baseHr" name="base_hr" value="135" min="60" max="200">
                            </div>
                            <div class="form-group">
                                <label for="maxHr">最大心率</label>
                                <input type="number" id="maxHr" name="max_hr" value="165" min="100" max="220">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="startTime">自定义开始时间</label>
                            <input type="datetime-local" id="startTime" name="start_time">
                        </div>
                    </div>

                    <!-- 高级设置组 - 专业用户配置 -->
                    <div class="card config-group config-secondary animate-scale-in animate-delay-5">
                        <h3>🦵 步频与功率</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="baseCadenceDisplay">基础步频</label>
                                <input type="number" id="baseCadenceDisplay" value="100" min="60" max="200" onchange="updateCadenceValue('base')">
                                <input type="hidden" id="baseCadence" name="base_cadence" value="50">
                            </div>
                            <div class="form-group">
                                <label for="maxCadenceDisplay">最大步频</label>
                                <input type="number" id="maxCadenceDisplay" value="140" min="100" max="240" onchange="updateCadenceValue('max')">
                                <input type="hidden" id="maxCadence" name="max_cadence" value="70">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="basePower">基础功率</label>
                                <input type="number" id="basePower" name="base_power" value="150" min="50" max="500">
                            </div>
                            <div class="form-group">
                                <label for="maxPower">最大功率</label>
                                <input type="number" id="maxPower" name="max_power" value="300" min="100" max="800">
                            </div>
                        </div>
                    </div>

                    <!-- 设备信息组 - 系统配置 -->
                    <div class="card config-group config-secondary animate-scale-in animate-delay-6">
                        <h3>📱 设备与格式</h3>
                        <div class="form-group">
                            <label>设备名称</label>
                            <input type="text" value="Forerunner 570" disabled style="background: rgba(255,255,255,0.05); color: #999; border-color: rgba(255,255,255,0.05);">
                            <input type="hidden" name="device_name" value="Forerunner 570">
                        </div>
                        <div class="form-group">
                            <label>固件版本</label>
                            <input type="text" value="12.70" disabled style="background: rgba(255,255,255,0.05); color: #999; border-color: rgba(255,255,255,0.05);">
                            <input type="hidden" name="device_version" value="12.70">
                        </div>
                        <div class="form-group">
                            <label>转换格式</label>
                            <input type="text" value="GPX → TCX" disabled style="background: rgba(255,255,255,0.05); color: #999; border-color: rgba(255,255,255,0.05);">
                        </div>
                    </div>
                </div>
                </div>
            </form>
        </div>

        <div class="convert-section animate-fade-in animate-delay-9">
            <button id="convertBtn" class="btn btn-primary" disabled>
                <span class="btn-icon">⚡</span>
                <span class="btn-text">开始转换</span>
                <div class="btn-ripple"></div>
            </button>
        </div>

        <div class="progress-section" id="progressSection" style="display: none;">
            <div class="card">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">正在初始化...</div>
                </div>
            </div>
        </div>

        <div class="result-section" id="resultSection" style="display: none;">
            <div class="card">
                <div class="result-content">
                    <div class="result-icon" id="resultIcon">⚡</div>
                    <div class="result-message" id="resultMessage">转换完成</div>
                    <div class="result-actions">
                        <button id="downloadBtn" class="btn btn-success">
                            <span class="btn-icon">⬇</span>
                            <span class="btn-text">下载 TCX 文件</span>
                            <div class="btn-ripple"></div>
                        </button>
                        <button id="resetBtn" class="btn btn-secondary">
                            <span class="btn-icon">↻</span>
                            <span class="btn-text">重新开始</span>
                            <div class="btn-ripple"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="features animate-fade-in animate-delay-10">
            <div class="card">
                <h3>核心功能</h3>
                <div class="feature-grid">
                <div class="feature-item">
                    <div class="feature-icon">⚡</div>
                    <div class="feature-content">
                        <div class="feature-title">极速转换</div>
                        <div class="feature-desc">先进算法实现毫秒级 GPX 到 TCX 格式转换</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">🎯</div>
                    <div class="feature-content">
                        <div class="feature-title">精确数据</div>
                        <div class="feature-desc">保持原始轨迹精度，确保数据完整性</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">🔒</div>
                    <div class="feature-content">
                        <div class="feature-title">隐私保护</div>
                        <div class="feature-desc">本地处理确保您的运动数据不会离开设备</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">📱</div>
                    <div class="feature-content">
                        <div class="feature-title">跨平台支持</div>
                        <div class="feature-desc">多平台兼容，随时随地进行无缝转换</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">⚙️</div>
                    <div class="feature-content">
                        <div class="feature-title">高级配置</div>
                        <div class="feature-desc">为专业运动员提供全面的参数自定义选项</div>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">🌍</div>
                    <div class="feature-content">
                        <div class="feature-title">智能定位</div>
                        <div class="feature-desc">智能天气集成，提供个性化训练洞察</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 多语言支持
        const translations = {
            'zh': {
                title: 'Run Beyond Imagination',
                subtitle: '随时随地，专业运动数据转换',
                status: '状态',
                online: '● 在线',
                format: '格式',
                speed: '速度',
                developer: '开发者',
                warning: '⚠️ 仅供测试使用，请勿用于正式比赛',
                uploadText: '拖拽GPX文件到此处',
                uploadHint: '支持.gpx格式 • 最大10MB • 即时处理',
                sportConfig: '🏃‍♂️ 运动设置',
                activityType: '运动类型',
                running: '跑步',
                cycling: '骑行',
                walking: '步行',
                targetPace: '目标配速 (分:秒/公里)',
                weight: '体重 (kg)',
                heartRate: '💓 心率与时间',
                baseHr: '基础心率',
                maxHr: '最大心率',
                cadenceConfig: '🦵 步频与功率',
                baseCadence: '基础步频 (显示)',
                maxCadence: '最大步频 (显示)',
                powerConfig: '⚡ 功率设置',
                basePower: '基础功率',
                maxPower: '最大功率',
                deviceInfo: '📱 设备与格式',
                deviceName: '设备名称',
                deviceVersion: '设备版本',
                timeConfig: '🕐 时间设置',
                startTime: '自定义开始时间 (可选)',
                caloriesPerKm: '卡路里/公里',
                convertBtn: '开始转换',
                initializing: '初始化中...',
                conversionComplete: '转换完成',
                downloadTcx: '下载TCX文件',
                reset: '重新转换',
                coreFeatures: '核心功能',
                instantProcessing: '即时处理',
                instantDesc: '先进算法实现亚秒级GPX到TCX转换',
                precisionData: '精确数据',
                precisionDesc: '保持原始轨迹精度，完整数据完整性',
                privacyFirst: '隐私优先',
                privacyDesc: '本地处理确保您的健身数据不会离开设备',
                universalAccess: '通用访问',
                universalDesc: '跨平台兼容性，随时随地无缝转换',
                advancedConfig: '高级配置',
                advancedDesc: '为专业运动员提供全面的参数定制',
                smartLocation: '智能定位',
                smartDesc: '智能天气集成，提供个性化训练洞察',
                routePreview: '🗺️ 路径预览',
                totalDistance: '总距离',
                trackPoints: '轨迹点',
                elevationGain: '海拔变化',
                routeDetails: '📍 轨迹详情',
                routeName: '名称',
                routeDesc: '描述',
                timeRange: '时间范围',
                avgSpeed: '平均速度',
                location: '位置',
                 country: '国家',
                 province: '省份',
                 city: '城市',
                 loadingLocation: '获取中...',
                 locationError: '获取失败',
                startPoint: '起点',
                endPoint: '终点',
                unnamedTrack: '未命名轨迹',
                unknown: '未知'
            },
            // 移除英文翻译，统一使用中文界面
        };

        // 统一使用中文界面
        function detectLanguage() {
            return 'zh';
        }

        // 应用翻译
        function applyTranslations(lang) {
            const t = translations[lang] || translations['zh'];
            if (!t) return;

            // 更新页面标题
            document.title = lang === 'zh' ? 'GPX转TCX转换器 - 专业运动数据转换工具' : 'GPX to TCX Converter - Professional Sports Data Tool';
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';

            // 更新页面内容
            document.querySelector('.welcome-title').textContent = t.title;
            document.querySelector('.welcome-subtitle').textContent = t.subtitle;
            
            // 更新信息项
            const infoItems = document.querySelectorAll('.info-item');
            if (infoItems[0]) {
                infoItems[0].querySelector('.info-label').textContent = t.format;
            }
            if (infoItems[1]) {
                infoItems[1].querySelector('.info-label').textContent = t.developer;
            }
            // 天气信息项保持原有标签

            // 更新警告信息
            document.querySelector('.status-warning').textContent = t.warning;

            // 更新上传区域
            document.querySelector('.upload-text').textContent = t.uploadText;
            document.querySelector('.upload-hint').textContent = t.uploadHint;

            // 更新配置区域
            const configTitles = document.querySelectorAll('.config-group h3');
            if (configTitles[0]) configTitles[0].textContent = t.sportConfig;
            if (configTitles[1]) configTitles[1].textContent = t.heartRate;
            if (configTitles[2]) configTitles[2].textContent = t.cadenceConfig;
            if (configTitles[3]) configTitles[3].textContent = t.powerConfig;
            if (configTitles[4]) configTitles[4].textContent = t.deviceInfo;
            if (configTitles[5]) configTitles[5].textContent = t.timeConfig;

            // 更新表单标签
            const labels = document.querySelectorAll('label');
            const labelMap = {
                '运动类型': t.activityType,
                'Activity Type': t.activityType,
                '目标配速 (分:秒/公里)': t.targetPace,
                'Target Pace (min:sec/km)': t.targetPace,
                '体重 (kg)': t.weight,
                'Weight (kg)': t.weight,
                '基础心率': t.baseHr,
                'Base Heart Rate': t.baseHr,
                '最大心率': t.maxHr,
                'Max Heart Rate': t.maxHr,
                '基础步频 (显示)': t.baseCadence,
                'Base Cadence (Display)': t.baseCadence,
                '最大步频 (显示)': t.maxCadence,
                'Max Cadence (Display)': t.maxCadence,
                '基础功率': t.basePower,
                'Base Power': t.basePower,
                '最大功率': t.maxPower,
                'Max Power': t.maxPower,
                '设备名称': t.deviceName,
                'Device Name': t.deviceName,
                '设备版本': t.deviceVersion,
                'Device Version': t.deviceVersion,
                '自定义开始时间 (可选)': t.startTime,
                'Custom Start Time (Optional)': t.startTime,
                '卡路里/公里': t.caloriesPerKm,
                'Calories/km': t.caloriesPerKm
            };

            labels.forEach(label => {
                const text = label.textContent.trim();
                if (labelMap[text]) {
                    label.textContent = labelMap[text];
                }
            });

            // 更新选项
            const options = document.querySelectorAll('option');
            options.forEach(option => {
                if (option.value === 'Running') option.textContent = t.running;
                if (option.value === 'Cycling') option.textContent = t.cycling;
                if (option.value === 'Walking') option.textContent = t.walking;
            });

            // 更新按钮
            document.querySelector('#convertBtn .btn-text').textContent = t.convertBtn;
            document.querySelector('#downloadBtn .btn-text').textContent = t.downloadTcx;
            document.querySelector('#resetBtn .btn-text').textContent = t.reset;

            // 更新功能区域
            document.querySelector('.features h3').textContent = t.coreFeatures;
            const featureTitles = document.querySelectorAll('.feature-title');
            const featureDescs = document.querySelectorAll('.feature-desc');
            
            if (featureTitles[0]) featureTitles[0].textContent = t.instantProcessing;
            if (featureDescs[0]) featureDescs[0].textContent = t.instantDesc;
            if (featureTitles[1]) featureTitles[1].textContent = t.precisionData;
            if (featureDescs[1]) featureDescs[1].textContent = t.precisionDesc;
            if (featureTitles[2]) featureTitles[2].textContent = t.privacyFirst;
            if (featureDescs[2]) featureDescs[2].textContent = t.privacyDesc;
            if (featureTitles[3]) featureTitles[3].textContent = t.universalAccess;
            if (featureDescs[3]) featureDescs[3].textContent = t.universalDesc;
            if (featureTitles[4]) featureTitles[4].textContent = t.advancedConfig;
            if (featureDescs[4]) featureDescs[4].textContent = t.advancedDesc;
            if (featureTitles[5]) featureTitles[5].textContent = t.smartLocation;
            if (featureDescs[5]) featureDescs[5].textContent = t.smartDesc;

            // 更新进度和结果文本
            const progressText = document.getElementById('progressText');
            const resultMessage = document.getElementById('resultMessage');
            if (progressText && (progressText.textContent.includes('INITIALIZING') || progressText.textContent.includes('正在初始化'))) {
                progressText.textContent = t.initializing;
            }
            if (resultMessage && (resultMessage.textContent.includes('CONVERSION') || resultMessage.textContent.includes('转换完成'))) {
                resultMessage.textContent = t.conversionComplete;
            }
        }

        // 获取当前语言的翻译
        function getTranslation(key) {
            return translations[currentLang][key] || key;
        }

        // 初始化语言
        const currentLang = detectLanguage();
        applyTranslations(currentLang);

        let selectedFile = null;
        let currentTaskId = null;

        // 文件上传处理
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const errorMessage = document.getElementById('errorMessage');
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');

        // 数字递增动画
        function animateCounter(element, start, end, duration = 1000) {
            const startTime = performance.now();
            const range = end - start;
            
            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // 使用缓动函数
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const current = Math.round(start + (range * easeOutQuart));
                
                element.textContent = current < 1 ? '< 1s' : current + 's';
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                }
            }
            
            requestAnimationFrame(updateCounter);
        }

        // 页面加载完成后启动动画
        document.addEventListener('DOMContentLoaded', () => {
            // 数字递增动画
            const counterElement = document.querySelector('.counter');
            if (counterElement) {
                setTimeout(() => {
                    animateCounter(counterElement, 5, 0, 2000);
                }, 1000);
            }
            
            // 添加微光呼吸效果到上传区域
            const uploadArea = document.querySelector('.file-upload');
            if (uploadArea) {
                uploadArea.style.animation = 'breathe 3s ease-in-out infinite';
            }
        });

        // 添加按钮涟漪效果
        function addRippleEffect(button, event) {
            const ripple = button.querySelector('.btn-ripple');
            if (!ripple) return;
            
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple-active');
            
            setTimeout(() => {
                ripple.classList.remove('ripple-active');
            }, 600);
        }

        // 为所有按钮添加涟漪效果
        document.addEventListener('click', (event) => {
            if (event.target.closest('.btn')) {
                addRippleEffect(event.target.closest('.btn'), event);
            }
        });

        // 点击上传区域
        fileUpload.addEventListener('click', () => {
            fileInput.click();
        });

        // 文件选择
        fileInput.addEventListener('change', handleFileSelect);

        // 拖拽处理
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });

        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });

        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // 检查文件类型
            if (!file.name.toLowerCase().endsWith('.gpx')) {
                showError('请选择GPX格式的文件');
                return;
            }

            // 检查文件大小 (16MB)
            if (file.size > 16 * 1024 * 1024) {
                showError('文件大小不能超过16MB');
                return;
            }

            selectedFile = file;
            updateUploadUI();
            fileUpload.classList.add('file-selected');
            convertBtn.disabled = false;
            convertBtn.classList.add('btn-ready');
            hideError();
            
            // 添加GPX预览功能
            parseAndDisplayGPX(file);
        }

        function updateUploadUI() {
            if (selectedFile) {
                fileUpload.innerHTML = `
                    <div class="upload-icon">✅</div>
                    <div class="upload-text">已选择: ${selectedFile.name}</div>
                    <div class="upload-hint">文件大小: ${(selectedFile.size / 1024 / 1024).toFixed(2)} MB</div>
                `;
            }
        }

        // 转换按钮
        convertBtn.addEventListener('click', startConversion);
        resetBtn.addEventListener('click', resetConversion);

        async function startConversion() {
            if (convertBtn.disabled) {
                return;
            }
            
            if (!selectedFile) {
                showError('请先选择GPX文件');
                return;
            }

            // 准备表单数据
            const formData = new FormData();
            formData.append('file', selectedFile);

            // 添加配置数据
            const configForm = document.getElementById('configForm');
            const formElements = configForm.elements;
            for (let element of formElements) {
                if (element.name && element.value) {
                    formData.append(element.name, element.value);
                }
            }

            try {
                convertBtn.disabled = true;
                convertBtn.classList.add('btn-loading');
                convertBtn.querySelector('.btn-text').textContent = '转换中...';
                convertBtn.querySelector('.btn-icon').textContent = '⏳';
                hideError();
                resultSection.style.display = 'none';

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    currentTaskId = result.task_id;
                    showProgress();
                    pollStatus();
                } else {
                    throw new Error(result.error || '上传失败');
                }
            } catch (error) {
                showError(error.message);
                resetUI();
            }
        }

        function resetConversion() {
            selectedFile = null;
            currentTaskId = null;
            
            // 重置文件上传区域
            fileUpload.innerHTML = `
                <div class="upload-icon">📁</div>
                <div class="upload-text">点击选择GPX文件或拖拽到此处</div>
                <div class="upload-hint">支持最大16MB的GPX文件</div>
            `;
            fileUpload.classList.remove('file-selected');
            
            // 隐藏GPX预览区域
            const gpxPreview = document.getElementById('gpxPreview');
            if (gpxPreview) {
                gpxPreview.style.display = 'none';
            }
            
            // 清理地图实例
            if (gpxMap) {
                gpxMap.remove();
                gpxMap = null;
            }
            
            // 重置按钮状态
            convertBtn.disabled = true;
            convertBtn.classList.remove('btn-ready', 'btn-loading');
            convertBtn.querySelector('.btn-text').textContent = '开始转换';
            convertBtn.querySelector('.btn-icon').textContent = '🔄';
            
            // 隐藏进度和结果
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            hideError();
        }

        function showProgress() {
            progressSection.style.display = 'block';
            progressSection.classList.add('fade-in');
            progressFill.style.width = '0%';
            progressText.textContent = '准备中...';
        }

        async function pollStatus() {
            if (!currentTaskId) return;

            try {
                const response = await fetch(`/status/${currentTaskId}`);
                const status = await response.json();

                if (response.ok) {
                    updateProgress(status.progress, status.message);

                    if (status.status === 'completed') {
                        showSuccess();
                    } else if (status.status === 'error') {
                        throw new Error(status.error || '转换失败');
                    } else {
                        // 继续轮询
                        setTimeout(pollStatus, 1000);
                    }
                } else {
                    throw new Error(status.error || '获取状态失败');
                }
            } catch (error) {
                showError(error.message);
                resetUI();
            }
        }

        function updateProgress(progress, message) {
            progressFill.style.width = progress + '%';
            progressText.textContent = message;
            
            // 添加进度动画
            if (progress > 0) {
                progressFill.classList.add('progress-active');
            }
        }

        function showSuccess() {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            resultSection.classList.add('fade-in');
            
            const resultIcon = document.getElementById('resultIcon');
            const resultMessage = document.getElementById('resultMessage');
            
            resultIcon.textContent = '✅';
            resultIcon.classList.add('success-bounce');
            resultMessage.textContent = '转换完成！';
            
            // 正确设置下载按钮的点击事件
            downloadBtn.onclick = () => {
                window.location.href = `/download/${currentTaskId}`;
            };
            resetUI();
        }

        function resetUI() {
            convertBtn.disabled = false;
            convertBtn.classList.remove('btn-loading');
            convertBtn.querySelector('.btn-text').textContent = '开始转换';
            convertBtn.querySelector('.btn-icon').textContent = '🔄';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            errorMessage.classList.add('shake');
            
            setTimeout(() => {
                errorMessage.classList.remove('shake');
            }, 600);
        }

        function hideError() {
            errorMessage.style.display = 'none';
            errorMessage.classList.remove('shake');
        }

        // 步频显示值转换函数
        function updateCadenceValue(type) {
            if (type === 'base') {
                const displayValue = document.getElementById('baseCadenceDisplay').value;
                const actualValue = Math.round(displayValue / 2);
                document.getElementById('baseCadence').value = actualValue;
            } else if (type === 'max') {
                const displayValue = document.getElementById('maxCadenceDisplay').value;
                const actualValue = Math.round(displayValue / 2);
                document.getElementById('maxCadence').value = actualValue;
            }
        }

        // 初始化步频值
        updateCadenceValue('base');
        updateCadenceValue('max');

        // 设置默认开始时间为当前时间
        const now = new Date();
        // 格式化为本地时间字符串 (YYYY-MM-DDTHH:MM)
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const localTimeString = `${year}-${month}-${day}T${hours}:${minutes}`;
        document.getElementById('startTime').value = localTimeString;

        // 个性化问候功能
         const weatherInline = document.getElementById('weatherInline');
         const weatherSummary = document.getElementById('weatherSummary');
         const greetingError = document.getElementById('greetingError');

         // 页面加载时自动获取天气信息
         async function loadGreeting() {
             try {
                 if (weatherInline) weatherInline.style.display = 'none';
                 if (greetingError) greetingError.style.display = 'none';

                 const response = await fetch('/greeting-info');
                 const data = await response.json();
 
                 if (data.success) {
                     // 显示天气信息（仅当天气数据可用时）
                     if (data.data.weather && weatherInline && weatherSummary) {
                         const weather = data.data.weather;
                         const location = data.data.location;
                         
                         // 创建简洁的天气摘要
                         const weatherText = `${weather.temperature} | ${weather.description} | ${location.city}`;
                         weatherSummary.textContent = weatherText;
                         
                         weatherInline.style.display = 'flex';
                         weatherInline.classList.add('slideIn');
                     }
                 } else {
                     throw new Error(data.error || '获取问候信息失败');
                 }
             } catch (error) {
                 if (greetingError) {
                     greetingError.textContent = `获取位置信息失败: ${error.message}`;
                     greetingError.style.display = 'block';
                     greetingError.classList.add('shake');
                     
                     setTimeout(() => {
                         greetingError.classList.remove('shake');
                     }, 600);
                 }
             }
         }
 
         // 页面加载完成后自动执行
         loadGreeting();
    </script>
    
    <!-- Leaflet地图库JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- GPX路径可视化功能 -->
    <script>
        let gpxMap = null;
        let gpxLayer = null;
        
        // GPX解析和地图显示功能
        function parseAndDisplayGPX(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const gpxContent = e.target.result;
                try {
                    const parser = new DOMParser();
                    const gpxDoc = parser.parseFromString(gpxContent, 'text/xml');
                    
                    // 提取轨迹点
                    const trackPoints = extractTrackPoints(gpxDoc);
                    if (trackPoints.length > 0) {
                        displayGPXOnMap(trackPoints, gpxDoc);
                        showRouteInfo(trackPoints, gpxDoc);
                    }
                } catch (error) {
                    console.error('GPX解析错误:', error);
                }
            };
            reader.readAsText(file);
        }
        
        // 提取GPX轨迹点
        function extractTrackPoints(gpxDoc) {
            const points = [];
            const trkpts = gpxDoc.querySelectorAll('trkpt');
            
            trkpts.forEach(point => {
                const lat = parseFloat(point.getAttribute('lat'));
                const lon = parseFloat(point.getAttribute('lon'));
                const eleElement = point.querySelector('ele');
                const timeElement = point.querySelector('time');
                
                if (!isNaN(lat) && !isNaN(lon)) {
                    points.push({
                        lat: lat,
                        lng: lon,
                        elevation: eleElement ? parseFloat(eleElement.textContent) : null,
                        time: timeElement ? new Date(timeElement.textContent) : null
                    });
                }
            });
            
            return points;
        }
        
        // 在地图上显示GPX路径
          function displayGPXOnMap(trackPoints, gpxDoc) {
              const previewDiv = document.getElementById('gpxPreview');
              const translation = translations[currentLang];
              previewDiv.style.display = 'block';
              
              // 更新预览标题
              const previewHeader = previewDiv.querySelector('.preview-header h4');
              if (previewHeader) {
                  previewHeader.textContent = translation.routePreview;
              }
            
            // 初始化地图
            if (gpxMap) {
                gpxMap.remove();
            }
            
            gpxMap = L.map('gpxMap').setView([trackPoints[0].lat, trackPoints[0].lng], 13);
            
            // 添加地图图层
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(gpxMap);
            
            // 创建路径
            const latlngs = trackPoints.map(point => [point.lat, point.lng]);
            gpxLayer = L.polyline(latlngs, {
                color: '#007AFF',
                weight: 4,
                opacity: 0.8
            }).addTo(gpxMap);
            
            // 添加起点和终点标记
            const startPoint = trackPoints[0];
            const endPoint = trackPoints[trackPoints.length - 1];
            
             L.marker([startPoint.lat, startPoint.lng], {
                 icon: L.divIcon({
                     html: '🏁',
                     className: 'start-marker',
                     iconSize: [20, 20]
                 })
             }).addTo(gpxMap).bindPopup(translation.startPoint);
             
             L.marker([endPoint.lat, endPoint.lng], {
                 icon: L.divIcon({
                     html: '🏆',
                     className: 'end-marker',
                     iconSize: [20, 20]
                 })
             }).addTo(gpxMap).bindPopup(translation.endPoint);
            
            // 调整地图视图以适应路径
            gpxMap.fitBounds(gpxLayer.getBounds(), { padding: [20, 20] });
        }
        
        // 显示路径信息
         function showRouteInfo(trackPoints, gpxDoc) {
             const stats = calculateRouteStats(trackPoints);
             const routeStatsDiv = document.getElementById('routeStats');
             const routeInfoDiv = document.getElementById('routeInfo');
             const trans = translations[currentLang];
             
             // 显示统计信息
             routeStatsDiv.innerHTML = `
                 <div class="stat-item">
                     <span class="stat-label">${trans.totalDistance}</span>
                     <span class="stat-value">${stats.distance.toFixed(2)} km</span>
                 </div>
                 <div class="stat-item">
                     <span class="stat-label">${trans.trackPoints}</span>
                     <span class="stat-value">${stats.points}</span>
                 </div>
                 <div class="stat-item">
                     <span class="stat-label">${trans.elevationGain}</span>
                     <span class="stat-value">${stats.elevationGain.toFixed(0)} m</span>
                 </div>
                 <div class="stat-item location-info">
                     <span class="stat-label">${trans.country}</span>
                     <span class="stat-value" id="location-country">${trans.loadingLocation}</span>
                 </div>
                 <div class="stat-item location-info">
                     <span class="stat-label">${trans.province}</span>
                     <span class="stat-value" id="location-province">${trans.loadingLocation}</span>
                 </div>
                 <div class="stat-item location-info">
                     <span class="stat-label">${trans.city}</span>
                     <span class="stat-value" id="location-city">${trans.loadingLocation}</span>
                 </div>
             `;
             
             // 显示详细信息
             const trackName = gpxDoc.querySelector('name')?.textContent || trans.unnamedTrack;
             const trackDesc = gpxDoc.querySelector('desc')?.textContent || '';
             
             routeInfoDiv.innerHTML = `
                 <div class="route-details">
                     <h5>${trans.routeDetails}</h5>
                     <p><strong>${trans.routeName}:</strong> ${trackName}</p>
                     ${trackDesc ? `<p><strong>${trans.routeDesc}:</strong> ${trackDesc}</p>` : ''}
                     <p><strong>${trans.timeRange}:</strong> ${stats.timeRange}</p>
                     <p><strong>${trans.avgSpeed}:</strong> ${stats.avgSpeed.toFixed(1)} km/h</p>
                 </div>
             `;
             
             // 获取地理位置信息
             if (trackPoints.length > 0) {
                 getLocationInfo(trackPoints[0].lat, trackPoints[0].lng);
             }
         }
        
        // 计算路径统计信息
        function calculateRouteStats(trackPoints) {
            let totalDistance = 0;
            let elevationGain = 0;
            let minTime = null;
            let maxTime = null;
            
            for (let i = 1; i < trackPoints.length; i++) {
                const prev = trackPoints[i - 1];
                const curr = trackPoints[i];
                
                // 计算距离
                const distance = calculateDistance(prev.lat, prev.lng, curr.lat, curr.lng);
                totalDistance += distance;
                
                // 计算海拔增益
                if (prev.elevation !== null && curr.elevation !== null) {
                    const elevDiff = curr.elevation - prev.elevation;
                    if (elevDiff > 0) {
                        elevationGain += elevDiff;
                    }
                }
                
                // 记录时间范围
                if (curr.time) {
                    if (!minTime || curr.time < minTime) minTime = curr.time;
                    if (!maxTime || curr.time > maxTime) maxTime = curr.time;
                }
            }
            
            // 计算平均速度
            let avgSpeed = 0;
            if (minTime && maxTime) {
                const timeHours = (maxTime - minTime) / (1000 * 60 * 60);
                avgSpeed = timeHours > 0 ? totalDistance / timeHours : 0;
            }
            
            const timeRange = minTime && maxTime ? 
                `${minTime.toLocaleString()} - ${maxTime.toLocaleString()}` : '未知';
            
            return {
                distance: totalDistance,
                points: trackPoints.length,
                elevationGain: elevationGain,
                timeRange: timeRange,
                avgSpeed: avgSpeed
            };
        }
        
        // 计算两点间距离（Haversine公式）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球半径（公里）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // 获取地理位置信息（反向地理编码）
        async function getLocationInfo(lat, lng) {
            const countryElement = document.getElementById('location-country');
            const provinceElement = document.getElementById('location-province');
            const cityElement = document.getElementById('location-city');
            const trans = translations[currentLang];
            
            try {
                // 使用Nominatim API进行反向地理编码
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=zh-CN,zh,en`);
                
                if (!response.ok) {
                    throw new Error('API请求失败');
                }
                
                const data = await response.json();
                
                if (data && data.address) {
                    const address = data.address;
                    
                    // 提取国家信息
                    const country = address.country || trans.locationError;
                    
                    // 提取省份信息（优先级：state > province > region）
                    const province = address.state || address.province || address.region || 
                                   address.county || trans.locationError;
                    
                    // 提取城市信息（优先级：city > town > village > municipality）
                    const city = address.city || address.town || address.village || 
                               address.municipality || address.suburb || trans.locationError;
                    
                    // 分别更新显示
                    countryElement.textContent = country;
                    provinceElement.textContent = province;
                    cityElement.textContent = city;
                } else {
                    countryElement.textContent = trans.locationError;
                    provinceElement.textContent = trans.locationError;
                    cityElement.textContent = trans.locationError;
                }
            } catch (error) {
                console.error('获取位置信息失败:', error);
                countryElement.textContent = trans.locationError;
                provinceElement.textContent = trans.locationError;
                cityElement.textContent = trans.locationError;
            }
        }
        

    </script>
</body>
</html>
